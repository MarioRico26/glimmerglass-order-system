generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/**
 * =========================
 * CORE
 * =========================
 */

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String
  role     Role
  approved Boolean @default(false)

  dealerId String? @unique
  dealer   Dealer? @relation(fields: [dealerId], references: [id])

  histories     OrderHistory[]
  inventoryTxns InventoryTxn[] @relation("InventoryTxnActor")

  createdAt DateTime @default(now())
}

model Dealer {
  id                    String    @id @default(uuid())
  name                  String
  email                 String    @unique
  phone                 String?
  address               String?
  city                  String?
  state                 String?
  agreementUrl          String?
  agreementSignatureUrl String?
  agreementSignedAt     DateTime?

  createdAt     DateTime       @default(now())
  orders        Order[]
  notifications Notification[]
  User          User?

  taxDocUrl             String?
  onboarding            Json      @default("{}")
  onboardingCompletedAt DateTime?
}

model Order {
  id              String      @id @default(uuid())
  deliveryAddress String
  status          OrderStatus
  paymentProofUrl String?
  notes           String?
  createdAt       DateTime    @default(now())

  // hardware checkboxes
  hardwareSkimmer    Boolean @default(false)
  hardwareAutocover  Boolean @default(false)
  hardwareReturns    Boolean @default(false)
  hardwareMainDrains Boolean @default(false)

  dealerId String
  dealer   Dealer @relation(fields: [dealerId], references: [id])

  poolModelId String
  poolModel   PoolModel @relation(fields: [poolModelId], references: [id])

  colorId String
  color   Color  @relation(fields: [colorId], references: [id])

  factoryLocationId String?
  factoryLocation   FactoryLocation? @relation(fields: [factoryLocationId], references: [id])

  histories     OrderHistory[]
  media         OrderMedia[]
  notifications Notification[]

  shippingMethod     String?
  requestedShipDate  DateTime?
  serialNumber       String?
  productionPriority Int?

  // Inventory (optional link)
  inventoryTxns InventoryTxn[]
}

model OrderHistory {
  id        String      @id @default(uuid())
  orderId   String
  order     Order       @relation(fields: [orderId], references: [id])
  status    OrderStatus
  comment   String?
  createdAt DateTime    @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id])
}

model OrderMedia {
  id         String    @id @default(uuid())
  orderId    String
  order      Order     @relation(fields: [orderId], references: [id])
  fileUrl    String
  type       MediaType
  uploadedAt DateTime  @default(now())

  docType         OrderDocType?
  visibleToDealer Boolean       @default(true)
}

model PoolModel {
  id       String  @id @default(uuid())
  name     String
  lengthFt Float
  widthFt  Float
  depthFt  Float
  shape    String?
  orders   Order[]
}

model Color {
  id        String  @id @default(uuid())
  name      String  @unique
  swatchUrl String?
  orders    Order[]
}

model Notification {
  id       String @id @default(uuid())
  dealerId String
  dealer   Dealer @relation(fields: [dealerId], references: [id])

  title     String
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id])

  @@index([dealerId, createdAt])
}

model FactoryLocation {
  id      String  @id @default(uuid())
  name    String  @unique
  address String?
  city    String?
  state   String?
  active  Boolean @default(true)

  orders Order[]

  // inverse relation for InventoryLocation.factoryLocation
  inventoryLocations InventoryLocation[]

  createdAt DateTime @default(now())
}

model AuditLog {
  id          String      @id @default(cuid())
  createdAt   DateTime    @default(now())
  actorUserId String?
  actorEmail  String?
  actorRole   Role?
  dealerId    String?
  orderId     String?
  action      AuditAction
  message     String
  meta        Json?

  @@index([createdAt])
  @@index([dealerId])
  @@index([orderId])
  @@index([action])
}

/**
 * =========================
 * INVENTORY
 * =========================
 */

enum InventoryLocationType {
  WAREHOUSE
  FACTORY
  TRUCK
  OTHER
}

enum InventoryTxnType {
  IN
  OUT
  ADJUST
}

model InventoryLocation {
  id   String @id @default(uuid())
  name String @unique

  type InventoryLocationType @default(WAREHOUSE)

  // optional link to a factory (only when type=FACTORY)
  factoryLocationId String?
  factoryLocation   FactoryLocation? @relation(fields: [factoryLocationId], references: [id])

  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  stocks InventoryStock[]
  txns   InventoryTxn[]

  // Daily reorder sheets per location (align with Excel "Date" + "QTY TO ORDER")
  reorderSheets InventoryReorderSheet[]

  @@index([factoryLocationId])
  @@index([type])
}

model InventoryCategory {
  id        String   @id @default(uuid())
  name      String   @unique
  active    Boolean  @default(true)
  createdAt DateTime @default(now())

  items InventoryItem[]
}

model InventoryItem {
  id String @id @default(uuid())

  // CompOne Product # from the sheet
  sku String @unique

  // Item from the sheet
  name String

  // UOM from the sheet (ea, gal, lb, roll, etc.)
  unit String @default("ea")

  // Category/Section from the sheet
  categoryId String?
  category   InventoryCategory? @relation(fields: [categoryId], references: [id])

  // ðŸ”‘ CLAVE para clonar el Excel
  sortOrder Int @default(9999)

  active   Boolean @default(true)
  minStock Int     @default(0)

  createdAt DateTime @default(now())

  stocks InventoryStock[]
  txns   InventoryTxn[]

  reorderLines InventoryReorderLine[]

  @@index([categoryId])
  @@index([sortOrder])
}

model InventoryStock {
  id         String @id @default(uuid())
  itemId     String
  locationId String

  // QTY ON HAND
  onHand Int @default(0)

  item     InventoryItem     @relation(fields: [itemId], references: [id])
  location InventoryLocation @relation(fields: [locationId], references: [id])

  @@unique([itemId, locationId])
  @@index([locationId])
  @@index([itemId])
}

model InventoryTxn {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  type  InventoryTxnType
  qty   Int
  notes String?

  itemId     String
  locationId String

  item     InventoryItem     @relation(fields: [itemId], references: [id])
  location InventoryLocation @relation(fields: [locationId], references: [id])

  actorUserId String?
  actorUser   User?   @relation("InventoryTxnActor", fields: [actorUserId], references: [id])

  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id])

  @@index([createdAt])
  @@index([itemId])
  @@index([locationId])
  @@index([orderId])
  @@index([actorUserId])
}

model InventoryReorderSheet {
  id         String   @id @default(uuid())
  locationId String
  date       DateTime
  notes      String?
  createdAt  DateTime @default(now())

  location InventoryLocation      @relation(fields: [locationId], references: [id])
  lines    InventoryReorderLine[]

  @@unique([locationId, date])
  @@index([date])
  @@index([locationId])
}

model InventoryReorderLine {
  id         String @id @default(uuid())
  sheetId    String
  itemId     String
  qtyToOrder Int    @default(0)

  sheet InventoryReorderSheet @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  item  InventoryItem         @relation(fields: [itemId], references: [id])

  @@unique([sheetId, itemId])
  @@index([itemId])
}

/**
 * =========================
 * ENUMS
 * =========================
 */

enum Role {
  ADMIN
  DEALER
  SUPERADMIN
}

enum OrderStatus {
  PENDING_PAYMENT_APPROVAL
  APPROVED // TEMPORARY ON DATA SCHEME
  IN_PRODUCTION
  PRE_SHIPPING
  COMPLETED
  CANCELED
}

enum MediaType {
  update
  proof
  photo
  note
}

enum AuditAction {
  USER_LOGIN
  DEALER_APPROVED
  DEALER_REVOKED
  ORDER_CREATED
  ORDER_STATUS_CHANGED
  FILE_UPLOADED
  AGREEMENT_SIGNED
  NOTIFICATION_SENT
}

enum OrderDocType {
  OTHER

  // Payment / finance
  PROOF_OF_PAYMENT
  QUOTE
  INVOICE
  PROOF_OF_FINAL_PAYMENT
  PAID_INVOICE
  BILL_OF_LADING

  // Production
  BUILD_SHEET
  POST_PRODUCTION_MEDIA

  // Pre-shipping
  SHIPPING_CHECKLIST
  PRE_SHIPPING_MEDIA

  // Dealer-facing docs
  WARRANTY
  MANUAL
}
